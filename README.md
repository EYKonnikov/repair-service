# Ремонтная служба — система управления заявками

Веб-приложение для приёма и обработки заявок в ремонтную службу.

## Функционал

- **Создание заявки** — форма с полями: имя клиента, телефон, адрес, описание проблемы
- **Панель диспетчера** — список всех заявок, фильтр по статусу, назначение мастера, отмена заявки
- **Панель мастера** — список назначенных заявок, действия «Взять в работу» и «Завершить»
- **Защита от гонки** — при параллельных запросах «Взять в работу» только один проходит, второй получает 409 Conflict

## Статусы заявки

`new` → `assigned` → `in_progress` → `done`

На любом этапе до `in_progress` заявку можно отменить (`canceled`).

## Стек технологий

- **Frontend:** React, TypeScript, Vite, TailwindCSS, shadcn/ui, TanStack Query, wouter
- **Backend:** Express.js, PostgreSQL, Drizzle ORM
- **Авторизация:** express-session + connect-pg-simple

## Запуск проекта

### Вариант A: Replit

Проект настроен для запуска на Replit. Просто нажмите Run.

### Вариант B: Локальный запуск

```bash
# 1. Установить зависимости
npm install

# 2. Настроить переменные окружения
export DATABASE_URL="postgresql://user:password@localhost:5432/repair_service"
export SESSION_SECRET="your-secret-key"

# 3. Создать базу данных PostgreSQL и применить схему
npm run db:push

# 4. Запустить приложение (dev-режим)
npm run dev
```

Приложение будет доступно по адресу http://localhost:5000

## Тестовые пользователи

При первом запуске БД автоматически заполняется начальными данными (seed).

| Логин       | Пароль         | Роль       | Имя            |
|-------------|----------------|------------|----------------|
| dispatcher  | dispatcher123  | Диспетчер  | Анна Петрова   |
| master1     | master123      | Мастер     | Иван Сидоров   |
| master2     | master123      | Мастер     | Дмитрий Козлов |

Также создаётся 5 тестовых заявок в разных статусах.

## Проверка защиты от гонки (race condition)

Действие «Взять в работу» защищено от параллельных запросов. При одновременном выполнении двух запросов только один из них успешен, второй получает ответ `409 Conflict`.

### Как проверить с помощью curl

1. Войдите как мастер и получите cookie:

```bash
curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"master1","password":"master123"}' \
  -c cookies.txt
```

2. Убедитесь, что есть заявка со статусом `assigned` (например, #2). Если нет — назначьте через панель диспетчера.

3. Запустите два параллельных запроса:

```bash
curl -s -X PATCH http://localhost:5000/api/requests/2/take -b cookies.txt &
curl -s -X PATCH http://localhost:5000/api/requests/2/take -b cookies.txt &
wait
```

**Ожидаемый результат:** один запрос вернёт обновлённую заявку со статусом `in_progress`, второй — `{"message":"Заявка уже взята в работу или её статус изменился"}` с кодом 409.

### Как это работает

Используется атомарный SQL UPDATE с условием `WHERE status = 'assigned' AND assigned_to = :masterId`. Если два запроса приходят одновременно, только один из UPDATE затрагивает строку (RETURNING возвращает результат), второй UPDATE не находит строку с нужным статусом и возвращает пустой результат, что приводит к ошибке 409.

## Структура проекта

```
├── client/                  # Frontend (React)
│   ├── src/
│   │   ├── components/      # UI-компоненты
│   │   ├── pages/           # Страницы приложения
│   │   ├── lib/             # Утилиты и контекст авторизации
│   │   └── hooks/           # React-хуки
│   └── index.html
├── server/                  # Backend (Express)
│   ├── routes.ts            # API-эндпоинты
│   ├── storage.ts           # Слой работы с БД
│   ├── seed.ts              # Начальные данные
│   └── index.ts             # Точка входа сервера
├── shared/
│   └── schema.ts            # Схема БД и Zod-валидация
├── DECISIONS.md             # Ключевые решения
└── PROMPTS.md               # Использованные промпты
```

## API-эндпоинты

| Метод  | URL                          | Описание                          |
|--------|------------------------------|-----------------------------------|
| POST   | /api/auth/login              | Вход в систему                    |
| GET    | /api/auth/me                 | Текущий пользователь              |
| POST   | /api/auth/logout             | Выход из системы                  |
| GET    | /api/masters                 | Список мастеров                   |
| POST   | /api/requests                | Создать заявку                    |
| GET    | /api/requests                | Список заявок (с фильтром ?status=) |
| GET    | /api/requests/my             | Заявки текущего мастера           |
| PATCH  | /api/requests/:id/assign     | Назначить мастера                 |
| PATCH  | /api/requests/:id/cancel     | Отменить заявку                   |
| PATCH  | /api/requests/:id/take       | Взять в работу (с защитой от гонки) |
| PATCH  | /api/requests/:id/complete   | Завершить заявку                  |
